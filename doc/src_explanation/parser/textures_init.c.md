# `src/parser/textures_init.c` 詳細解説

## 概要
XPM形式のテクスチャファイルを読み込み、MiniLibXの画像オブジェクトに変換してメモリに展開します。壁（東西南北）、ドア、スプライトなどの全テクスチャのロードを一括して行います。

## 依存関係
*   `cub3d.h`: `t_game`, `t_img` 構造体。
*   `mlx.h`: `mlx_xpm_file_to_image`, `mlx_get_data_addr`。

## 関数詳細

### 1. `load_texture`
#### プロトタイプ
`int load_texture(t_game *game, int idx, char *path)`

#### 戻り値
*   `1`: ロード成功。
*   `0`: ロード失敗（ファイル無し、破損、メモリ不足等）。

#### 解説
指定されたパスのXPMファイルを読み込み、`game` 構造体内の適切なメンバ変数に保存します。保存先はインデックス `idx` によって振り分けられます（0-3: 壁, -1: ドア, -2,-3: スプライト）。また、読み込み後にピクセルデータへのアドレスを取得し、後の描画処理（`get_texture_color`）で高速にアクセスできるようにします。

### 2. `init_textures`
#### プロトタイプ
`int init_textures(t_game *game)`

#### 戻り値
*   `1`: 全テクスチャのロード成功。
*   `0`: いずれかのロード失敗。

#### 解説
パースされたパス情報（`game->tex.*`）を使って壁テクスチャをロードし、さらに固定パスにあるボーナス用テクスチャ（ドア、スプライト）もロードします。1つでも失敗すれば即座に `0` を返します。

### 3. `get_texture_color`
#### プロトタイプ
`unsigned int get_texture_color(t_img *tex, int x, int y)`

#### 戻り値
指定座標 `(x, y)` のピクセル色（`0xRRGGBB` 形式）。

#### 解説
テクスチャ画像上の特定座標の色を取得します。座標が画像の範囲外にはみ出さないようガード処理を入れた上で、画像のメモリアドレス計算式 `addr + y * line_length + x * (bpp / 8)` を用いて直接色の値を読み取ります。

### コード行別解説 (`load_texture`)

| 行番号 | コード | 詳細解説 |
| :--- | :--- | :--- |
| 15 | `int load_texture(...)` | **テクスチャロード汎用関数**<br>`idx` に応じて格納先を切り替えます。 |
| 18-25 | `if (idx == -1) ...` | インデックスによる保存先ポインタ `tex` の決定ロジック。 |
| 27 | `tex->img = mlx_xpm_file_to_image(...)` | **XPM読み込み**<br>MLXの関数を使ってファイルから画像を生成します。幅と高さも同時に取得されます。 |
| 28-29 | `if (!tex->img) return (0);` | 読み込み失敗時は `0` を返します。 |
| 30-31 | `tex->addr = mlx_get_data_addr(...)` | **データアドレス取得**<br>描画時にピクセル単位でアクセスするためのポインタを取得します。これが無いと高速な描画ができません。 |

### コード行別解説 (`get_texture_color`)

| 行番号 | コード | 詳細解説 |
| :--- | :--- | :--- |
| 60-67 | `if (x < 0) ...` | **範囲外アクセス防止**<br>計算誤差などでテクスチャ座標がわずかにマイナスやサイズオーバーになった場合、強制的に範囲内に収めます（クランプ処理）。これがないとセグメンテーションフォールトの原因になります。 |
| 68 | `dst = tex->addr + ...` | **メモリアドレス計算**<br>2次元座標 `(x, y)` を1次元メモリ上のバイトオフセットに変換します。 |
| 69 | `return (*(unsigned int *)dst);` | 計算したアドレスにある値を `unsigned int` (カラーコード) としてキャストして返します。 |
