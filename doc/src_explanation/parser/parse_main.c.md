# `src/parser/parse_main.c` 詳細解説

## 概要
マップファイルのパース処理全体を統括するファイルです。ファイルを開き、`get_next_line` で1行ずつ読み込みながら、テクスチャパス、色設定、そしてマップ配列を順次解析していきます。

## 依存関係
*   `parse.h`: パース関連の関数プロトタイプ。
*   `get_next_line.h`: 行読み込み関数。
*   `fcntl.h`: `open` 関数定数。

## 関数詳細

### 1. `process_elem_line`
#### プロトタイプ
`int process_elem_line(char *line, t_game *game, int *count)`

#### 戻り値
*   `1`: 正常に処理された（空行やコメント含む）、または要素が見つかった。
*   `0`: 不正な行（識別子がない等）が見つかった。

#### 解説
ファイルの「設定部分」（マップ本体より前の部分）の1行を処理します。空行やコメント行はスキップし、テクスチャ(`NO`,`SO`...)や色(`F`,`C`)の設定行であれば解析関数を呼び出します。

### 2. `parse_elem`
#### プロトタイプ
`char *parse_elem(int fd, t_game *game)`

#### 戻り値
*   `char *`: マップ部分の最初の行（設定要素が全て揃った後に現れた、マップデータと思われる最初の行）。
*   `NULL`: エラー時（ただし通常は `perror_and_exit` で終了するため到達しない）。

#### 解説
ループを回して設定要素（全6種類：東西南北テクスチャ＋床天井色）が揃うまで読み続けます。要素が揃う前に不明な行があればエラーとします。要素が6つ揃った時点で、その次の行（マップの開始行）を呼び出し元に返します。

### 3. `parse`
#### プロトタイプ
`void parse(char *filename, t_game *game)`

#### 戻り値
なし

#### 解説
パース処理のエントリーポイントです。ファイルオープン、要素パース、マップパース、バリデーション（文字チェック、閉鎖チェック、プレイヤー検出）を順次実行します。

### コード行別解説 (`parse`)

| 行番号 | コード | 詳細解説 |
| :--- | :--- | :--- |
| 65 | `fd = open(filename, O_RDONLY);` | **ファイルオープン**<br>読み込み専用モードでファイルを開きます。 |
| 66-69 | `if (fd < 0) ...` | オープンに失敗した場合（ファイル未存在や権限不足）、エラー終了します。 |
| 70 | `first_line = parse_elem(fd, game);` | **要素パース**<br>設定部分を読み込みます。戻り値 `first_line` にはマップデータの1行目が格納されます。 |
| 71-72 | `if (!parse_map(fd, game, first_line))` | **マップパース**<br>残りの行を読み込み、2次元配列 `game->map.grid` を作成します。失敗時はエラー終了。 |
| 73-74 | `if (!check_map_chars(game))` | **文字種チェック**<br>マップ内に許可されていない文字（0, 1, 2, N, S, E, W, 空白 以外）が含まれていないか確認します。 |
| 75-76 | `if (!check_map_closed(game))` | **壁の閉鎖チェック**<br>マップが壁(`1`)で囲まれているか、外に繋がっていないかを確認（Flood Fill等のアルゴリズムを使用）。 |
| 77-78 | `if (!find_player(game))` | **プレイヤー検出**<br>マップ内にプレイヤー（N/S/E/W）が「ただ1人」存在することを確認し、その位置と向きを記録します。 |
