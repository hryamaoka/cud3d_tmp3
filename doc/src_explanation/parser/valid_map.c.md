# `src/parser/valid_map.c` 詳細解説

## 概要
読み込まれたマップデータの整合性を検証します。許可されていない文字の使用チェックと、マップが壁で完全に囲まれているか（閉鎖性）のチェックを行います。

## 依存関係
*   `parse.h`: パース用ヘッダ。
*   `libft.h`: `ft_strchr` 等。

## 関数詳細

### 1. `is_valid_char` / `check_map_chars`
マップ内の全文字を走査し、`0` `1` `2` `D`（ドア） `NSWE`（プレイヤー） スペース 以外の文字が含まれていないかを確認します。

### 2. `is_walkable`
指定された文字が「移動可能エリア（プレイヤーが侵入できる、または閉鎖性の検証対象となるエリア）」であるかを判定します。壁(`1`)とスペース以外は移動可能とみなします。

### 3. `check_surroundings`
#### プロトタイプ
`static int check_surroundings(t_game *game, int x, int y)`

#### 戻り値
*   `1`: 周囲が安全（壁または他の移動可能マスで囲まれている）。
*   `0`: 周囲に穴（スペースまたはマップ外）がある。

#### 解説
指定された座標 `(x, y)` の上下左右を確認します。もし上下左右のいずれかが「スペース」であるか、あるいは「マップの端（インデックス境界）」である場合、そのマスから「虚無」へ抜け出せてしまうため、閉じていないと判断します。

### 4. `check_map_closed`
#### プロトタイプ
`int check_map_closed(t_game *game)`

#### 戻り値
*   `1`: マップは閉じている。
*   `0`: マップが開いている（エラー）。

#### 解説
マップ内の「移動可能なマス（0, 2, NSWE等）」すべてに対して `check_surroundings` を実行します。一つでも外部に露出しているマスがあれば、マップ全体として無効と判定します。

### コード行別解説 (`check_map_closed`)

| 行番号 | コード | 詳細解説 |
| :--- | :--- | :--- |
| 68-70 | `while (y < ...)` | **全セル走査**<br>マップの全てのマスを一つずつチェックします。 |
| 71 | `if (is_walkable(grid[y][x]))` | **対象判定**<br>壁「1」やスペースそのものはチェック不要です。「中身（床やアイテム）」が外に漏れていないかを確認します。 |
| 72-73 | `if (!check_surroundings(...))` | **周囲確認**<br>そのマスの隣接4方向をチェックします。 |
| 73 | `return (0);` | 一箇所でも穴があればその時点でマップは無効と判定され、処理を終了します。 |
