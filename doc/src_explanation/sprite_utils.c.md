# `src/render/sprite_utils.c` 詳細解説

## 概要
スプライト描画のための計算ロジック（ソート、投影変換、ピクセル描画）を担当します。

## コード詳細解説

| 行番号 | コード | 解説 |
| :--- | :--- | :--- |
| **16** | `void sort_sprites(...)` | **バブルソート**<br>スプライトの距離配列に基づいて、描画順序配列(`order`)を並び替えます。要素数が少ないためバブルソートでも十分高速です。 |
| **40** | `void setup_sprite_vars(...)` | **投影変換（Projection）**<br>スプライトのワールド座標をカメラスペース（相対座標）に変換し、さらにスクリーン座標に変換します。 |
| **48-49** | `  inv_det = 1.0 / ...` | カメラ行列の逆行列式（行列式）の逆数。これを用いて座標変換を行います。 |
| **54** | `  vars->sprite_screen_x = ...` | 画面上での中心X座標を計算します。 |
| **56/63** | `  vars->sprite_height = ...` | **サイズ計算**<br>距離に反比例してスプライトの高さと幅を決定します。 |
| **73** | `static void draw_stripe_pixels(...)` | **ピクセル描画**<br>垂直ストライプ内の各ピクセルを描画します。 |
| **89** | `    if ((color & 0x00FFFFFF) != 0)` | **透過処理**<br>黒色（0x000000）を透過色として扱い、描画をスキップします。これにより四角い画像ではなく切り抜かれたキャラクタとして表示されます。 |
| **102** | `      vars->transform_y < game->z_buffer[stripe]` | **深度テスト**<br>スプライトが壁の手前にある場合のみ描画します。Zバッファと比較することで、壁の裏に隠れる表現を実現しています。 |
