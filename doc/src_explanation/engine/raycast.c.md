# `src/engine/raycast.c` 詳細解説

## 概要
レイキャスティングの中核となる処理を行います。画面左端から右端まで1列ずつ光線（レイ）を飛ばし、壁との衝突判定、距離計算、テクスチャ座標の算出を経て、最終的な描画関数を呼び出します。3D空間の計算ロジックが詰まっています。

## 依存関係
*   `raycast.h`: レイキャスティング関連関数プロトタイプ。
*   `render.h`: 描画関数プロトタイプ。
*   `<math.h>`: `fabs`, `floor` 等。

## 関数詳細

### 1. `init_ray`
#### プロトタイプ
`void init_ray(t_game *game, int x)`

#### 戻り値
なし

#### 解説
画面上の列 `x` に対応する光線の方向ベクトルと初期値を設定します。
*   `camera_x`: 画面中心を0、左端を-1、右端を1とした座標系。
*   `ray_dir`: プレイヤーの向きとカメラ平面から計算される光線の方向。
*   `delta_dist`: レイがグリッド境界を1つ超えるのに必要な距離。
*   `step`: どちらの方向（正/負）に進むか。
*   `side_dist`: 次のグリッド境界までの初期距離。

### 2. `get_wall_x`
#### プロトタイプ
`static double get_wall_x(t_game *game)`

#### 戻り値
`double`: 壁のどこにヒットしたかを表す小数値（0.0〜1.0）。

#### 解説
壁に衝突した正確な位置を計算します。これはテクスチャのどの列を表示するか（テクスチャX座標）を決定するために必要です。
*   縦面(`side=0`)に当たった場合：Y座標の小数部分。
*   横面(`side=1`)に当たった場合：X座標の小数部分。

### 3. `get_tex_x`
#### プロトタイプ
`static int get_tex_x(t_game *game, t_img *tex, double wall_x)`

#### 戻り値
`int`: テクスチャ上のX座標（0 〜 tex->width - 1）。

#### 解説
`wall_x` をテクスチャ幅に合わせて整数座標に変換します。
壁の向き（裏表）によって、テクスチャが反転しないように座標を反転させる処理（`tex_width - tex_x - 1`）もここで行います。

### 4. `calc_wall_and_tex`
#### プロトタイプ
`static void calc_wall_and_tex(...)`

#### 戻り値
なし（引数ポインタ `draw`, `tex`, `tex_x` に結果を格納）。

#### 解説
DDA完了後、以下の最終計算を行います。
1.  `perp_wall_dist`: 壁までの垂直距離（魚眼効果の補正済み）。
2.  `line_height`: 画面上に描画すべき壁の高さ（距離に反比例）。
3.  `draw_start/end`: 描画開始点と終了点（画面からはみ出る場合は0やheight-1に制限）。
4.  使用するテクスチャの選択（`select_texture`）。
5.  テクスチャX座標の算出（`get_tex_x`）。

### 5. `raycast`
#### プロトタイプ
`void raycast(t_game *game)`

#### 戻り値
なし

#### 解説
画面の全横幅分（0からwidthまで）ループし、各列に対して以下を実行します。
1.  レイの初期化 (`init_ray`)
2.  DDAアルゴリズムによる壁探索 (`perform_dda`)
3.  距離とテクスチャの計算 (`calc_wall_and_tex`)
4.  Zバッファへの距離保存
5.  天井と床の描画 (`draw_floor_ceiling`)
6.  壁の描画 (`draw_textured_line`)

### コード行別解説 (`calc_wall_and_tex`)

| 行番号 | コード | 詳細解説 |
| :--- | :--- | :--- |
| 54 | `if (game->ray.side == 0)` | **距離計算**<br>ヒットした面に応じて計算式を変えます。これはユークリッド距離ではなく、カメラ平面までの垂直距離を求めています（これにより壁が丸く歪むのを防ぎます）。 |
| 62 | `game->ray.line_height = ...` | 壁の高さを計算します。`距離 * 高さ = 定数` の反比例関係です。 |
| 63-68 | `draw[0] = ... draw[1] = ...` | **描画範囲決定**<br>壁の中心を画面中央に合わせます。上下がはみ出す場合のクランプ処理も含みます。 |
