# `src/engine/raycast_utils.c` 詳細解説

## 概要
DDA (Digital Differential Analyzer) アルゴリズムの実装や、レイキャスティングの初期化・テクスチャ選択などの補助関数群です。`raycast.c` のコードを分割して可読性を高める役割を果たします。

## 依存関係
*   `raycast.h`: レイキャスティング用ヘッダ。

## 関数詳細

### 1. `perform_dda`
#### プロトタイプ
`void perform_dda(t_game *game)`

#### 戻り値
なし（`game->ray.hit` が1になるまでループ）

#### 解説
**DDAアルゴリズム**を実行し、レイが壁に当たるまでグリッド上を1マスずつ進めます。
*   `side_dist` が小さい方（X軸またはY軸）を優先して進めることで、正確に交点をたどります。
*   壁(`1`)またはドア(`D`)に当たったら `hit = 1` となりループを抜けます。マップ外に出た場合も安全のためヒット扱いで停止させます。

### 2. `select_texture`
#### プロトタイプ
`void select_texture(t_game *game, t_img **tex)`

#### 戻り値
なし（`*tex` に選択されたテクスチャのポインタを代入）。

#### 解説
壁の種類やレイが当たった面に応じて、使用するテクスチャを決定します。
*   ドア(`D`)ならドアテクスチャ。
*   `side == 0` (縦面) かつ `ray_dir_x > 0` (右向き) なら **西** の壁（内側から見て）。
*   `ray_dir_x < 0` (左向き) なら **東** の壁。
*   同様に `side == 1` (横面) なら **北** または **南** の壁を選択します。
(※東西南北の割り当ては座標系の取り方によりますが、課題要件に従い方角に対応させます)

### 3. `init_ray_step_x` / `init_ray_step_y`
#### プロトタイプ
`void init_ray_step_(x|y)(t_game *game)`

#### 戻り値
なし

#### 解説
レイの進行方向に応じて、ステップ量（1 or -1）と、最初の境界線までの距離(`side_dist`)を初期化します。
*   正方向なら現在位置から右端までの距離。
*   負方向なら現在位置から左端までの距離。

### コード行別解説 (`perform_dda`)

| 行番号 | コード | 詳細解説 |
| :--- | :--- | :--- |
| 16 | `while (game->ray.hit == 0)` | **DDAループ**<br>壁に当たるまで無限に繰り返します（ただしマップ外判定で抜ける安全策あり）。 |
| 17-25 | `if (game->ray.side_dist_x < ...)` | **ステップ更新**<br>X方向とY方向のうち、次の境界線に近い方へ進みます。これにより斜めのレイも正しくグリッドを横断します。更新と同時に `side` (0:縦, 1:横) も記録します。 |
| 26-30 | `if (... map_x < 0 ...)` | **範囲外ガード**<br>レイがマップの外に出た場合、無限ループを防ぐためにループを強制終了します。 |
| 31-33 | `if (... == '1' || ... == 'D')` | **衝突判定**<br>現在のマスが壁かドアならループ終了フラグを立てます。 |
