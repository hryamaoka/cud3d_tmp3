# `src/render/sprite_utils.c` 詳細解説

## 概要
スプライト描画のための計算ロジック（座標変換、スケーリング）や、ソート関数、ピクセル描画といった低レベルな処理を集めたユーティリティファイルです。

## 依存関係
*   `render.h`: `t_sprite_vars` 等。
*   `utils.h`: `ft_abs`。

## 関数詳細

### 1. `sort_sprites`
#### プロトタイプ
`void sort_sprites(int *order, double *dist, int amount)`

#### 戻り値
なし

#### 解説
バブルソート等の単純なソートアルゴリズムを用いて、スプライトを「距離が遠い順（降順）」に並び替えます。`dist` 配列（距離）と連動させて `order` 配列（スプライトのインデックス）を入れ替えます。

### 2. `setup_sprite_vars`
#### プロトタイプ
`void setup_sprite_vars(...)`

#### 戻り値
なし（`vars` 構造体に結果を格納）

#### 解説
スプライトのワールド座標をカメラ座標（スクリーン上の位置）に変換します。
1.  プレイヤーからの相対座標 (`sprite_x/y`) を計算。
2.  逆行列を使ってカメラ平面上の座標 (`transform_x/y`) に変換。`transform_y` が奥行きになります。
3.  画面上の中心X座標 (`sprite_screen_x`) を算出。
4.  距離に基づく高さ (`sprite_height`) と幅 (`sprite_width`) を計算し、描画開始・終了位置を決定します。

### 3. `draw_stripe`
#### プロトタイプ
`void draw_stripe(...)`

#### 戻り値
なし

#### 解説
スプライトの特定の縦1列（ストライプ）を描画するかどうかを判定します。
*   スプライトがカメラの前にあるか (`transform_y > 0`)。
*   ストライプが画面内にあるか。
*   **Zバッファ判定**: その位置に壁がないか、あるいは壁より手前にあるか (`transform_y < z_buffer[stripe]`) を確認します。
条件を満たす場合のみ `draw_stripe_pixels` を呼び出します。

### 4. `draw_stripe_pixels`
#### プロトタイプ
`static void draw_stripe_pixels(...)`

#### 戻り値
なし

#### 解説
実際にピクセルを塗る関数です。Y座標ループの中でテクスチャ座標を計算し、透明色（黒`0x000000`など。ここでは `color & 0x00FFFFFF != 0` で判定）以外のピクセルを画面バッファに書き込みます。

### コード行別解説 (`setup_sprite_vars`)

| 行番号 | コード | 詳細解説 |
| :--- | :--- | :--- |
| 48-49 | `inv_det = 1.0 / ...` | **逆行列式**<br>カメラ行列の逆行列を求めるための行列式です。これを用いてワールド座標をカメラ座標系へ変換します。 |
| 55 | `sprite_screen_x = ...` | **投影変換**<br>3D空間上の点を2D画面上のX座標に投影します。 |
| 70 | `vars->tex = ...` | **アニメーション**<br>`frame_count` を利用してテクスチャを切り替え、アニメーション効果を実現しています（例：10フレームごとに画像を変更）。 |
