# `src/render/sprite.c` 詳細解説

## 概要
マップ上のオブジェクト（アイテムや敵など）であるスプライトの管理と描画を担当します。初期化時の位置登録から、毎フレームのソート、そしてビルボード処理（常にプレイヤーの方を向く処理）を含めた描画ループまでを行います。

## 依存関係
*   `render.h`: スプライト関連構造体、関数プロトタイプ。

## 関数詳細

### 1. `init_sprites`
#### プロトタイプ
`void init_sprites(t_game *game)`

#### 戻り値
なし

#### 解説
マップ全体をスキャンし、`2`（スプライト）の個数をカウントしてメモリを確保します。その後、再度スキャンしてスプライトの座標をリストに登録し、マップ上のデータを `0`（床）に書き換えます。これにより、スプライトがある場所もプレイヤーが通行可能になります。

#### コード行別解説 (`init_sprites`)

| 行番号 | コード | 詳細解説 |
| :--- | :--- | :--- |
| 22-30 | `while (y < ...)` | **個数カウント**<br>マップ内の `2` の数を数えます。 |
| 32 | `game->sprites = malloc(...)` | スプライト構造体の配列を確保します。 |
| 41-42 | `game->sprites[i].x = x + 0.5;` | **中心補正**<br>グリッド座標(整数)の中心に配置するため `+ 0.5` しています。 |
| 43 | `game->map.grid[y][x] = '0';` | **マップ書き換え**<br>壁判定等で邪魔にならないよう、マップデータ上は「床」に変更します。 |

### 2. `render_sprite` (static)
#### プロトタイプ
`static void render_sprite(t_game *game, int i, int *order)`

#### 戻り値
なし

#### 解説
個別のスプライトを描画します。`setup_sprite_vars` で計算された情報に基づき、左端(`draw_start_x`)から右端(`draw_end_x`)まで、1列ずつ `draw_stripe` を呼び出して画面に描画します。

#### コード行別解説 (`render_sprite`)

| 行番号 | コード | 詳細解説 |
| :--- | :--- | :--- |
| 58 | `setup_sprite_vars(game, i, order, &vars);` | スプライトの画面上の位置やサイズなどの変数を一括計算します（`sprite_utils.c` で定義）。 |
| 60-63 | `while (stripe < vars.draw_end_x)` | **描画ループ**<br>計算された描画開始列から終了列までループし、`draw_stripe` で縦1列ずつ描画します。 |

### 3. `draw_sprites`
#### プロトタイプ
`void draw_sprites(t_game *game)`

#### 戻り値
なし

#### 解説
スプライト描画のメイン関数です。
1.  各スプライトの「プレイヤーからの距離」を計算します。
2.  **遠い順** に描画するためにスプライトをソートします（近い順だと、奥のスプライトが手前のものの上に描画されてしまうため）。
3.  ソートされた順序で `render_sprite` を呼び出し、描画を行います。

#### コード行別解説 (`draw_sprites`)

| 行番号 | コード | 詳細解説 |
| :--- | :--- | :--- |
| 73-74 | `order = malloc(...); dist = malloc(...);` | ソート用の作業メモリ（順序配列と距離配列）を確保します。 |
| 80-83 | `dist[i] = ...` | **距離計算**<br>ユークリッド距離の二乗を計算します。平方根(`sqrt`)を取らなくても大小比較は可能なため、高速化のために二乗のまま扱います。 |
| 86 | `sort_sprites(order, dist, ...);` | 距離に基づいて描画順序(`order`配列)を並び替えます（`sprite_utils.c` で定義）。 |
| 88-91 | `while (i < game->num_sprites)` | ソートされた順序でスプライト描画関数を呼び出します（遠いものから順に）。 |
