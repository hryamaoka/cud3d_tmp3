# `src/core/window.c` 詳細解説

## 概要
MiniLibX (MLX) ライブラリを使用したウィンドウ管理とイベントハンドリングを担当します。ウィンドウの作成、描画バッファ（イメージ）の確保、Zバッファのメモリ確保、およびキーボードやマウスイベントのフック登録を行います。

## 依存関係
*   `cub3d.h`: `t_game` 構造体。
*   `mlx.h`: MiniLibX関数群。

## 関数詳細

### 1. `close_game`
#### プロトタイプ
`int close_game(t_game *game)`

#### 戻り値
常に `0`（形式上）。実際には `exit(0)` でプログラムを終了します。

#### 解説
ウィンドウの「閉じる」ボタン（×ボタン）が押された時に呼び出されるコールバック関数です。リソースを解放して正常終了します。

### 2. `init_window`
#### プロトタイプ
`int init_window(t_game *game)`

#### 戻り値
成功時: `1`<br>失敗時: `0`

#### 解説
MLXの初期化、ウィンドウ作成、画像バッファ作成、Zバッファ確保、イベントフックの一括登録を行います。

### コード行別解説 (`init_window`)

| 行番号 | コード | 詳細解説 |
| :--- | :--- | :--- |
| 26 | `game->mlx = mlx_init();` | **MLX接続初期化**<br>グラフィックシステムへの接続を確立します。 |
| 27-28 | `if (!game->mlx) return (0);` | 初期化失敗時は `0` を返します。 |
| 30-31 | `screen_w = 1024; ...` | **解像度設定**<br>画面解像度を幅1024, 高さ768に設定します。 |
| 33 | `game->win = mlx_new_window(...);` | **ウィンドウ生成**<br>指定したサイズとタイトル("cub3D")で新しいウィンドウを開きます。 |
| 37 | `game->img.img = mlx_new_image(...)` | **画像バッファ生成**<br>ウィンドウサイズと同じ大きさのオフスクリーン画像を作成します。直接ウィンドウに描画するのではなく、まずこの画像にピクセルを書き込み、最後に一括でウィンドウに転送（ダブルバッファリング）することでちらつきを防ぎます。 |
| 38-39 | `game->img.addr = mlx_get_data_addr(...)` | **アドレス取得**<br>画像バッファの生データ（ピクセル配列）へのポインタを取得します。これを使ってピクセル単位の色の書き込みを行います。 |
| 43 | `game->z_buffer = malloc(...)` | **Zバッファ確保**<br>画面の横幅分の浮動小数点配列を確保します。これは各垂直ラインごとの「壁までの距離」を記録し、特定のスプライトが壁の奥にあるか手前にあるかを判定するために使用されます。 |
| 47 | `mlx_hook(game->win, 2, 1L << 0, key_press, game);` | **キー入力フック**<br>イベント番号 `2` (KeyPress) に対し、`key_press` 関数を登録します。キーが押されるとこの関数が呼ばれます。 |
| 48 | `mlx_hook(game->win, 6, 1L << 6, mouse_handler, game);` | **マウス移動フック**<br>イベント番号 `6` (MotionNotify) に対し、`mouse_handler` 関数を登録します。マウス視点移動に使用します。 |
| 49 | `mlx_hook(game->win, 17, 0, close_game, game);` | **ウィンドウ閉じるフック**<br>イベント番号 `17` (DestroyNotify) に対し、`close_game` 関数を登録します。×ボタン用です。 |
| 50 | `mlx_loop_hook(game->mlx, render_frame, game);` | **ループフック**<br>イベントが発生していない時（アイドル時）に常に呼び出される関数として `render_frame` を登録します。これがゲームの描画ループ（毎フレームの更新）となります。 |
