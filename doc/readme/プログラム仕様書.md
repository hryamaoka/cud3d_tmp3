# Cub3D プログラム仕様書

本プロジェクト `cub3d_wsl` のアーキテクチャとプログラム動作仕様について解説します。

## 1. 全体アーキテクチャ
本プログラムは **MiniLibX** (MLX) ライブラリを使用したイベント駆動型のアプリケーションです。
大きく分けて「初期化 (Initialization)」「メインループ (Game Loop)」「終了処理 (Cleanup)」の3つのフェーズで構成されています。

### データ構造
全てのゲームデータは `t_game` 構造体に集約されています（`includes/cub3d.h` 参照）。
*   `mlx`, `win`: MLXのインスタンスとウィンドウポインタ
*   `img`: 描画用バッファ（ここにピクセルを書き込み、最後にウィンドウへ転送）
*   `map`: マップデータ（グリッド、幅、高さ）
*   `player`: プレイヤーの位置、向き、カメラ平面
*   `ray`: レイキャスティング計算用の一時変数群
*   `tex`: テクスチャ情報
*   `z_buffer`: スプライト描画の深度判定用バッファ

## 2. プログラムフロー

### 2.1 エントリーポイント (`srcs/main.c`)
1.  **引数チェック**: 引数が `.cub` ファイル1つであることを確認。
2.  **拡張子チェック**: `srcs/check/check.c` で `.cub` であるか確認。
3.  **ゲーム構造体初期化**: `init_game` で初期値を設定。
4.  **パース (`parse`)**: `.cub` ファイルを読み込み、テクスチャパス、色、マップデータを構造体に格納。
5.  **ウィンドウ初期化 (`init_window`)**: MLXの初期化、ウィンドウ作成、画像バッファ作成。
6.  **テクスチャロード**: 指定された `.xpm` ファイルを読み込む。
7.  **メインループ開始**: `mlx_loop` でイベント待機状態へ移行。

### 2.2 初期化詳細 (`srcs/init/`)
*   **`init_window`**:
    *   `mlx_new_window` で 1024x768 のウィンドウを作成。
    *   `mlx_new_image` でオフスクリーンバッファを作成（ダブルバッファリング的役割）。
    *   **フック登録**:
        *   `KeyPress`: キー入力 (`key_press`)
        *   `MotionNotify`: マウス移動 (`mouse_handler`)
        *   `DestroyNotify`: 閉じるボタン (`close_game`)
        *   `LoopHook`: 毎フレーム呼び出される関数 (`render_frame`)

### 2.3 メインループ (`srcs/render/render.c` - `render_frame`)
`mlx_loop` により、何も操作がなくても常に `render_frame` が呼ばれ続けます。

1.  **`raycast(game)`**: 壁を描画計算。
2.  **`draw_sprites(game)`**: スプライト（アイテム等）を描画。
3.  **`draw_minimap(game)`**: 左上にミニマップを描画（ボーナス機能）。
4.  **`mlx_put_image_to_window`**: 完成した画像バッファをウィンドウに転送して表示更新。

## 3. レンダリングエンジン (`srcs/raycast/`)

レイキャスティング法 (DDAアルゴリズム) を使用して3D視点を描画します。

### ステップ詳細
画面の横幅分（0 ～ `screen_w`）だけ以下の計算を繰り返します (`raycast.c`)。

1.  **レイの初期化 (`init_ray`)**:
    *   カメラ平面 (`plane_x`, `plane_y`) と現在のx座標から、レイの方向ベクトルを計算。
2.  **DDAの実行 (`perform_dda`)**:
    *   レイをグリッド上で1マスずつ進め、壁 (`1`) に当たるまでループ。
    *   壁までの垂直距離 (`perp_wall_dist`) を計算（魚眼レンズ効果の補正済み）。
3.  **描画範囲の計算 (`calc_wall_and_tex`)**:
    *   壁までの距離から、画面上に描画すべき壁の高さ (`line_height`) を算出。
    *   描画開始位置 (`draw_start`) と終了位置 (`draw_end`) を決定。
    *   テクスチャのどの列を使うか (`tex_x`) を計算。
4.  **描画 (`render.c`)**:
    *   **天井と床**: `draw_ceiling` / `draw_floor` で指定色で塗りつぶし。
    *   **壁**: `draw_textured_line` でテクスチャのピクセルを取得し、壁の高さ分だけ描画。

## 4. 入力処理 (`srcs/input/`)
*   **移動**: W, A, S, D キーでプレイヤー座標 (`player.x`, `player.y`) を更新。
*   **回転**: ←, → キー または マウス移動で、プレイヤーの向きベクトル (`dir`) とカメラ平面 (`plane`) を回転行列で回転。
*   **終了**: ESCキーでプログラム終了。

## 5. 終了処理 (`close_game`)
*   確保したメモリ（マップ、テクスチャ、MLXイメージ等）を全て `free` して、メモリリークを防ぎつつ `exit(0)` で終了。
